api.valvx.se {
	encode gzip

	header Content-Security-Policy "default-src 'none';"
	header Cross-Origin-Embedder-Policy "require-corp"
	header Cross-Origin-Resource-Policy "same-origin"
	header Cross-Origin-Opener-Policy "same-origin"
	header Referrer-Policy "strict-origin-when-cross-origin"
	header Permissions-Policy ""
	header X-Content-Type-Options "nosniff"
	header X-Frame-Options "DENY"
	header X-XSS-Protection "0"
	header X-Robots-Tag "none"

	reverse_proxy {
		to 127.0.0.1:4000
	}
}

app.valvx.se {
	encode gzip

	# All security headers restored â€” no more iframe workarounds needed
	# The Speckle viewer is now embedded directly via @speckle/viewer SDK
	header Cross-Origin-Embedder-Policy "require-corp"
	header Cross-Origin-Resource-Policy "same-origin"
	header Cross-Origin-Opener-Policy "same-origin"
	header Referrer-Policy "strict-origin-when-cross-origin"
	header Permissions-Policy ""
	header X-Content-Type-Options "nosniff"
	header X-Frame-Options "DENY"
	header X-XSS-Protection "0"
	header X-Robots-Tag "none"

	reverse_proxy {
		to 127.0.0.1:5000
	}
}

storage.valvx.se {
	encode gzip

	header Content-Security-Policy "default-src 'self'; frame-ancestors https://app.valvx.se;"
	header Cross-Origin-Embedder-Policy "require-corp"
	header Cross-Origin-Resource-Policy "cross-origin"
	header Cross-Origin-Opener-Policy "same-origin"
	header Referrer-Policy "strict-origin-when-cross-origin"
	header Permissions-Policy ""
	header X-Content-Type-Options "nosniff"
	header X-XSS-Protection "0"
	header X-Robots-Tag "none"

	reverse_proxy {
		to 127.0.0.1:9000

		header_down -X-XSS-Protection
	}
}

speckle.valvx.se {
	# Speckle is now API-only (no frontend iframe needed)
	# CORS allows the ValvX frontend to make direct API calls for 3D data streaming
	@cors header Origin https://app.valvx.se
	header @cors Access-Control-Allow-Origin "https://app.valvx.se"
	header @cors Access-Control-Allow-Methods "GET, POST, OPTIONS"
	header @cors Access-Control-Allow-Headers "Authorization, Content-Type, Accept"
	header @cors Access-Control-Max-Age "86400"

	@options method OPTIONS
	handle @options {
		header Access-Control-Allow-Origin "https://app.valvx.se"
		header Access-Control-Allow-Methods "GET, POST, OPTIONS"
		header Access-Control-Allow-Headers "Authorization, Content-Type, Accept"
		respond 204
	}

	reverse_proxy {
		to 127.0.0.1:8080
	}
}

storage.speckle.valvx.se {
	reverse_proxy {
		to 127.0.0.1:9200
	}
}

:80 {
	handle /healthz {
		respond "ok"
	}
}
